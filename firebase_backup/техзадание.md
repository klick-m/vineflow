# Technical Specification: VinEFlow Mobile App

**Role:** Senior Flutter Developer & Enologist.
**Goal:** Build a mobile application for home winemakers to track batches, perform lab calculations, and diagnose wine faults.
**Stack:** Flutter, Firebase (Firestore, Auth, Hosting).

---

## 1. System Architecture & Data Model

### 1.1 Firestore Collections
- **`batches` (Collection):**
  - `id`: String (UUID)
  - `name`: String (e.g., "Merlot 2025")
  - `type`: Enum (RED, WHITE, FRUIT)
  - `status`: Enum (MACERATION, ACTIVE_FERMENTATION, SECONDARY_FERMENTATION, AGING, BOTTLED)
  - `raw_weight`: Double (kg)
  - `current_volume`: Double (liters)
  - `target_abv`: Double (%)
  - `created_at`: Timestamp

- **`measurements` (Sub-collection of `batches`):**
  - `timestamp`: Timestamp
  - `brix`: Double
  - `sg`: Double (Specific Gravity)
  - `ph`: Double
  - `temp`: Double (°C)
  - `notes`: String
  - `source`: Enum (MANUAL, ISPINDEL)

---

## 2. Core Winemaking Logic (Service: `WinemakingMath`)

Implement the following algorithms:

### 2.1 Unit Conversion
- **Brix to SG:** $$SG = 1 + (Brix / (258.6 - ((Brix / 258.2) * 227.1)))$$
- **Potential Alcohol (from SG):** $$ABV_{pot} = (SG_{start} - SG_{end}) / 0.0075$$

### 2.2 Adjustments
- **Chaptalization (Adding Sugar):** `SugarToAdd (g) = (TargetABV - PotentialABV) * 17 * CurrentVolume`
- **Sulphitation (KMS Calculation):** `KMS (g) = (TargetFreeSO2 * CurrentVolume) / 570`  
  *(Note: 570 is the constant for Potassium Metabisulfite activity)*

### 2.3 Volume Estimation
- **Red Wine Output:** `Weight * 0.72`
- **White Wine Output:** `Weight * 0.65`

---

## 3. Application Workflow (State Machine)

### Phase 1: Maceration (Red Scheme)
- **Feature:** "Cap Punch" (Пробивка шапки) logger.
- **Alerts:** Notify user every 8 hours if no punch-down is recorded.
- **Transition:** Button "Pressing" (Отжим) moves status to `ACTIVE_FERMENTATION`.

### Phase 2: Active Fermentation
- **Feature:** Monitor airlock activity (bubbles per minute).
- **Logic:** If SG is stable for 3 consecutive days, notify "Fermentation Complete. Time for racking."

### Phase 3: Secondary Fermentation & Aging
- **Feature:** Racking (Слив с осадка) reminders.
- **Feature:** SO2 maintenance calculator based on pH levels.

---

## 4. SOS 911 Module (Diagnostic Tree)

Interactive quiz based on symptoms:
- **Smell: Rotten Eggs ($H_2S$):** -> Action: "Aerate immediately + add yeast nutrients (DAP)."
- **Sight: White Film (Mycoderma):** -> Action: "Remove film, sulfite (30mg/L), top up the vessel."
- **Taste: Vinegar Tone:** -> Action: "Check for Acetobacter, consider pasteurization or discard."

---

## 5. UI/UX Requirements

- **Theme:** Dark Mode.
- **Primary Color:** Deep Wine (#4A0E0E), Secondary: Golden (Must), Background: Charcoal.
- **Dashboard:** Cards for active batches showing current stage and the last SG/Brix reading.
- **Quick Action (+):** One-tap entry for SG/Temp readings.
- **Charts:** Time-series graph showing Density (SG) drop over time.

---

## 6. Implementation Instructions for AI Agent

1. **Step 1 (Firebase):** Use Firebase MCP to initialize the project, setup Firestore rules, and create the schema.
2. **Step 2 (Data):** Create `WinemakingMath` service with the formulas provided.
3. **Step 3 (Offline):** Implement local caching for `batches` and `measurements` to ensure functionality in wine cellars without internet.
4. **Step 4 (UI):** Build the Main Dashboard and the Batch Creation Wizard (Weight -> Type -> Initial Brix).
5. **Step 5 (Automation):** Prepare a basic HTTP endpoint structure for future iSpindel integration.